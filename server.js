var playerList=[],timerSec="00",timerMin=3,orangeScore=0,blueScore=0,background_index=0,isGoal=!1,isGameStart=!1;const express=require("express"),app=express(),server=require("http").createServer(app),io=require("socket.io")(server),p2=require("p2");app.use("/js",express.static(__dirname+"/js")),app.use("/assets",express.static(__dirname+"/assets")),app.get("/",function(e,i){i.sendFile(__dirname+"/index.html")}),server.listen(80,function(){console.log("Listening on port 80")});var world=new p2.World({gravity:[0,0]}),playerMaterial=new p2.Material,ballMaterial=new p2.Material,boxMaterial=new p2.Material;world.addContactMaterial(new p2.ContactMaterial(playerMaterial,ballMaterial,{friction:0,restitution:.5})),world.addContactMaterial(new p2.ContactMaterial(ballMaterial,boxMaterial,{friction:0,restitution:1}));var ball=new p2.Body({mass:1,damping:.1,position:[640,360],angle:0,velocity:[0,0],angularVelocity:0,fixedRotation:!1});ball.addShape(new p2.Circle({radius:24,material:ballMaterial})),world.addBody(ball);var boxes=[];boxes[0]=new p2.Body({position:[640,40]}),boxes[0].addShape(new p2.Box({width:1140,height:2,material:boxMaterial})),boxes[1]=new p2.Body({position:[640,680]}),boxes[1].addShape(new p2.Box({width:1140,height:2,material:boxMaterial})),boxes[2]=new p2.Body({position:[67,145]}),boxes[2].addShape(new p2.Box({width:2,height:200,material:boxMaterial})),boxes[3]=new p2.Body({position:[1210,145]}),boxes[3].addShape(new p2.Box({width:2,height:200,material:boxMaterial})),boxes[4]=new p2.Body({position:[67,580]}),boxes[4].addShape(new p2.Box({width:2,height:200,material:boxMaterial})),boxes[5]=new p2.Body({position:[1210,580]}),boxes[5].addShape(new p2.Box({width:2,height:200,material:boxMaterial})),boxes[6]=new p2.Body({position:[34,250]}),boxes[6].addShape(new p2.Box({width:68,height:2,material:boxMaterial})),boxes[7]=new p2.Body({position:[34,465]}),boxes[7].addShape(new p2.Box({width:68,height:2,material:boxMaterial})),boxes[8]=new p2.Body({position:[1244,250]}),boxes[8].addShape(new p2.Box({width:68,height:2,material:boxMaterial})),boxes[9]=new p2.Body({position:[1244,465]}),boxes[9].addShape(new p2.Box({width:68,height:2,material:boxMaterial})),boxes[10]=new p2.Body({position:[4,232]}),boxes[10].addShape(new p2.Box({width:2,height:465,material:boxMaterial})),boxes[11]=new p2.Body({position:[1276,232]}),boxes[11].addShape(new p2.Box({width:2,height:465,material:boxMaterial}));for(var i=0;i<boxes.length;i++)boxes[i].mass=0,world.addBody(boxes[i]);setInterval(function(){playerList.length>=2?(0==isGoal&&(0==--timerSec&&(timerSec="00"),timerSec<0&&(timerMin--,timerSec=59)),0==isGameStart&&(restartGame(),io.emit("destroy_waitText"),isGameStart=!0)):isGameStart&&(restartGame(),io.emit("waitPlayer"),isGameStart=!1)},1e3);var lastTimeSeconds=(new Date).getTime();function onNewPlayer(e){var i=new Player(this.id,e.sprite,e.radius,e.scale,e.speed,e.speedMax,e.kickPower,e.name);i.body=new p2.Body({mass:5,damping:.1,position:[i.x,i.y],angle:0,velocity:[0,0],angularVelocity:0,fixedRotation:!0}),i.body.addShape(new p2.Circle({radius:i.radius})),world.addBody(i.body);for(var t=0;t<boxes.length;t++)world.disableBodyCollision(i.body,boxes[t]);for(t=0;t<playerList.length;t++)this.emit("create_oPlayer",{id:playerList[t].id,x:playerList[t].body.position[0],y:playerList[t].body.position[1],xdir:playerList[t].xdir,sprite:playerList[t].sprite,name:playerList[t].name,team:playerList[t].team});this.broadcast.emit("create_oPlayer",{id:i.id,x:i.x,y:i.y,xdir:i.xdir,sprite:i.sprite,name:i.name,team:i.team}),playerList.push(i),this.emit("server_info",{background_index:background_index,team:i.team,orangeScore:orangeScore,blueScore:blueScore}),console.log("created new player with id "+this.id)}function onDisconnect(){var e=find_playerID(this.id);e&&(world.removeBody(e.body),playerList.splice(playerList.indexOf(e),1)),this.broadcast.emit("remove_player",{id:this.id}),console.log("disconnect player "+this.id)}function onPlayer_move(e){var i=find_playerID(this.id);0!=e.hspd&&(i.xdir=e.hspd),i.body.velocity[0]+=e.hspd*i.speed,i.body.velocity[1]+=e.vspd*i.speed}function onPlayer_kick(){var e=find_playerID(this.id);e&&p2.Broadphase.boundingRadiusCheck(e.body,ball)&&(ball.velocity[0]*=e.kickPower,ball.velocity[1]*=e.kickPower,io.emit("sound_kick"))}function resetGame(){ball.position[0]=640,ball.position[1]=360,ball.velocity[0]=0,ball.velocity[1]=0,ball.angle=0,isGoal=!1;for(var e=0;e<playerList.length;e++)"blue"==playerList[e].team&&(playerList[e].body.position[0]=240,playerList[e].body.position[1]=360,playerList[e].xdir=1),"orange"==playerList[e].team&&(playerList[e].body.position[0]=1040,playerList[e].body.position[1]=360,playerList[e].xdir=-1),playerList[e].body.velocity[0]=0,playerList[e].body.velocity[1]=0;io.emit("reset")}function restartGame(){timerSec="00",timerMin=3,orangeScore=0,blueScore=0,isGoal=!1,resetGame(),io.emit("restart",background_index)}setInterval(function(){var e=(new Date).getTime()-lastTimeSeconds;lastTimeSeconds=(new Date).getTime(),world.step(1/60,e,10)},1e3/60),io.on("connection",function(e){e.on("connected_player",onNewPlayer),e.on("disconnect",onDisconnect),e.on("player_move",onPlayer_move),e.on("player_kick",onPlayer_kick),0==isGameStart&&e.emit("waitPlayer"),setInterval(function(){var i=find_playerID(e.id);i&&(e.emit("move_player",{x:i.body.position[0],y:i.body.position[1],xdir:i.xdir}),e.broadcast.emit("move_oPlayer",{id:i.id,x:i.body.position[0],y:i.body.position[1],xdir:i.xdir}),i.body.position[0]=clamp(i.body.position[0],0,1280),i.body.position[1]=clamp(i.body.position[1],0,720),i.body.velocity[0]=clamp(i.body.velocity[0],-i.speedMax,i.speedMax),i.body.velocity[1]=clamp(i.body.velocity[1],-i.speedMax,i.speedMax),io.emit("update_ball",{x:ball.position[0],y:ball.position[1],angle:ball.angle}),ball.velocity[0]=clamp(ball.velocity[0],-100,100),ball.velocity[1]=clamp(ball.velocity[1],-100,100),ball.angle+=(Math.abs(ball.velocity[0])>Math.abs(ball.velocity[1])?ball.velocity[0]:ball.velocity[1])/10,0==isGoal&&isGameStart&&(ball.position[0]>=1232.9&&ball.position[1]>=252.5&&ball.position[1]<=447.6&&(isGoal=!0,blueScore++,io.emit("blueGoal"),setTimeout(function(){resetGame(),io.emit("destroy_goalText")},3e3)),ball.position[0]<=48.3&&ball.position[1]>=252.5&&ball.position[1]<=447.6&&(orangeScore++,isGoal=!0,io.emit("orangeGoal"),setTimeout(function(){resetGame(),io.emit("destroy_goalText")},3e3))),io.emit("update_timer",{timerMin:timerMin,timerSec:timerSec}),0==timerMin&&"00"==timerSec&&0==isGoal&&(isGoal=!0,setTimeout(function(){restartGame(),io.emit("destroy_winText"),background_index<3?background_index++:background_index=0},5e3)))},1e3/60)});var Player=function(e,i,t,a,o,r,l,s){if(this.id=e,this.sprite=i,this.radius=t,this.scale=a,this.speed=o,this.speedMax=r,this.kickPower=l,this.name=s,blue_length()>orange_length())this.team="orange",this.x=1040,this.y=360,this.xdir=-1;else if(blue_length()<orange_length())this.team="blue",this.x=240,this.y=360,this.xdir=1;else{0==Math.floor(2*Math.random())?(this.team="blue",this.x=240,this.y=360,this.xdir=1):(this.team="orange",this.x=1040,this.y=360,this.xdir=1)}};